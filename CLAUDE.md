# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Hugo static site for **Château de Laubardemont**, a wedding/event venue near Bordeaux. Combines a Hugo frontend with a PHP contact form backend. All content is in French.

## Commands

### Hugo

```bash
hugo server          # Dev server with live reload
hugo server -D       # Include draft content
hugo                 # Build to public/
```

### Tailwind CSS (run from themes/laubardemont/)

```bash
cd themes/laubardemont
npm run dev          # Watch mode: assets/css/main.css → static/css/styles.css
npm run build        # Minified production build
```

### PHP Tests

```bash
vendor/bin/phpunit                       # Run all tests
vendor/bin/phpunit tests/MailerTest.php  # Run single test file
```

### Google Reviews

```bash
./scripts/fetch-reviews.sh    # Fetches reviews via Google Places API, writes data/google_reviews.json
```

Requires `.env` with `GOOGLE_API_KEY` and `GOOGLE_PLACE_ID`.

## Architecture

### Theme Structure

All theme code lives in `themes/laubardemont/`. Key directories:

- `layouts/_default/` — Page templates. `home.html` (homepage), `sections.html` (multi-section pages like château), `contact.html`, `partenaires.html`
- `layouts/partials/` — Reusable components: `header.html`, `footer.html`, `contact-form.html`, `avis-google.html`, `gallery.html`, plus SVG icons in `partials/icons/`
- `assets/css/main.css` — Tailwind entry point with custom styles (header, burger menu, nav)
- `static/php/` — PHP backend (see below)

### Content

All content uses **TOML frontmatter** (`+++` delimiters). Pages define structured data in frontmatter params (hero sections, steps, info items) that templates iterate over.

- `content/_index.md` — Homepage
- `content/chateau/_index.md` — Château page (uses `sections.html` layout)
- `content/contact.md` — Contact page
- `content/histoire/index.md` — History page
- `content/partenaires.md` — Partners page

### PHP Contact Form

Entry point: `themes/laubardemont/static/php/contact-submit.php`

Flow: POST → host whitelist check → rate limit (IP-based, `/tmp/`) → honeypot check → validate required fields → sanitize → send email → optional BelEvent API call (fire-and-forget) → 303 redirect.

Helper modules in `static/php/helpers/`:
- `sanitize.php` — `cleanText()`, `cleanEmail()`, `cleanMessage()`, `normalizeDate()`
- `validate.php` — `isHoneypotTriggered()`, `requireFields()`, `isValidEmail()`
- `mailer.php` — `sendContactMail()` with SMTP or native `mail()` via `MAILER_DSN` config
- `http.php` — `requirePost()`, `requireAllowedHost()`, `rateLimit()`, `redirect303()`
- `template.php` — `buildContactBody()` generates HTML email
- `belevent.php` — `sendToBelEvent()` for lead capture API
- `logger.php` — `writeDebug()` (enabled via `DEBUG_LOG` in `config.php`)

PHP config: `static/php/config.php` — constants for recipients, SMTP DSN, allowed hosts, BelEvent API keys.

For dev email testing, set `MAILER_DSN = 'smtp://localhost:1025'` and use MailCatcher.

### CSS Pipeline

Tailwind CSS 3.4 processes `themes/laubardemont/assets/css/main.css` → `static/css/styles.css`. Hugo's `hugo_stats.json` is mounted as an asset for Tailwind's content purging. Cache busting is configured in `hugo.toml` for PostCSS/Tailwind config changes.

Custom breakpoint: 900px for desktop/mobile nav switch.

Color palette: `stone-*` (base), `amber-*` (accents/interactions).

### Data

`data/google_reviews.json` — Generated by `scripts/fetch-reviews.sh`, consumed by `partials/avis-google.html`.

## Git Workflow

- `main` — production
- `develop` — active development branch

## Key Config

- Hugo requires v0.116.0+
- PHP 8.0+ with `declare(strict_types=1)` throughout
- PHP functions use camelCase; constants use UPPER_SNAKE_CASE
- PHP helpers are loaded via Composer autoload (`composer.json` → files array)
- PHPUnit bootstrap (`tests/bootstrap.php`) defines test-only constants so tests run independently of `config.php`
